<!DOCTYPE html>
{% extends "base.html" %}
{% load static %}

{% block title %}Заявка #{{ ticket.id }} | Техподдержка{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/tickets.css' %}">
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="ticket-detail-section">
      <h3>Заявка #{{ ticket.id }} — {{ ticket.subject }}</h3>
      <p><strong>Автор:</strong> {{ ticket.user.username }} ({{ ticket.user.get_role_display }})</p>
      <p><strong>Статус:</strong> {{ ticket.get_status_display }}</p>
      <p><strong>Категория:</strong> {{ ticket.get_category_display }}</p>
      <p><strong>Линия поддержки:</strong> L{{ ticket.support_line }}</p>
      <p><strong>Создана:</strong> {{ ticket.created_at|date:"d.m.Y H:i" }}</p>
      <p><strong>Обновлена:</strong> {{ ticket.updated_at|date:"d.m.Y H:i" }}</p>

      <hr />
      <h5>Описание:</h5>
      <p>{{ ticket.description }}</p>

      {% if user.role == 'support' %}
        <div class="mt-4 p-3 bg-light rounded">
          <h5>Ответить пользователю</h5>
          <form method="post" action="{% url 'ticket_add_comment' ticket.id %}">
            {% csrf_token %}
            <div class="mb-2">
              <textarea name="comment" class="form-control" rows="3" 
                placeholder="Напишите ответ респонденту..." required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Отправить ответ</button>
          </form>
        </div>
      {% endif %}

      <hr />
      <h5>История изменений:</h5>
      <p>*(пока не реализовано)*</p>

      <div class="mt-4">
        {% if user.role == 'support' %}
          {% if user.support_level == 1 and ticket.support_line == 1 and ticket.status not in 'resolved,escalated' %}
            <a href="{% url 'ticket_escalate' ticket.id %}" class="btn btn-warning me-2">Эскалировать на L2/L3</a>
            <form method="post" action="{% url 'ticket_resolve' ticket.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-success">Проблема решена</button>
            </form>
          {% elif user.support_level == 2 and ticket.support_line == 2 and ticket.status == 'escalated' %}
            <form method="post" action="{% url 'ticket_resolve' ticket.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-success">Проблема решена</button>
            </form>
          {% endif %}

        {% endif %}
        <a href="{% url 'ticket_list' %}" class="btn btn-secondary ms-2">Назад к списку</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}